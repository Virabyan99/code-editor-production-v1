<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sandbox</title>
</head>
<body>
  <script>
    const workerScript = `
      const THROTTLE_MS = 16; // ~= 60fps
      let lastSent = 0;

      function safeSerialize(arg) {
        if (arg === null || typeof arg !== 'object') return String(arg);
        try {
          return JSON.stringify(arg, (_key, value) =>
            typeof value === 'function' ? '[fn]' : value
          );
        } catch {
          return '[unserialisable]';
        }
      }

      function postLog(message) {
        const now = performance.now();
        if (now - lastSent < THROTTLE_MS) return; // drop frame
        lastSent = now;
        self.postMessage({ type: 'log', payload: message });
      }

      self.console = {
        log: (...args) => {
          const serializedArgs = args.map(a => safeSerialize(a)).join(' ');
          postLog(serializedArgs);
        },
        warn: (...args) => postMessage({ type: 'warn', data: args }),
        error: (...args) => postMessage({ type: 'error', data: args }),
        clear: () => self.postMessage({ type: 'clear' }),
      };

      self.onmessage = (event) => {
        try {
          const code = event.data;
          const func = new Function(code);
          func();
          postMessage({ type: 'done' });
        } catch (error) {
          self.console.error(error.message);
          postMessage({ type: 'done' });
        }
      };
    `;

    const blob = new Blob([workerScript], { type: 'application/javascript' });
    const worker = new Worker(URL.createObjectURL(blob));

    window.addEventListener('message', (event) => {
      if (event.data.type === 'run') {
        worker.postMessage(event.data.code);
      }
    });

    worker.onmessage = (event) => {
      window.parent.postMessage(event.data, '*');
    };

    worker.onerror = (error) => {
      window.parent.postMessage({ type: 'error', data: [error.message] }, '*');
    };
  </script>
</body>
</html>